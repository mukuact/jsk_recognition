<launch>
  <arg name="INPUT" default="/camera/rgb/image_rect_color" />
  <arg name="INPUT_ON" default="false" />
  <arg name="NET" default="zf" />

  <group unless="$(arg INPUT_ON)">
    <include file="$(find openni2_launch)/launch/openni2.launch">
      <arg name="depth_registration" value="True" />
    </include>
  </group>


  <node name="faster_rcnn"
        pkg="jsk_perception" type="faster_rcnn_caffenet.py" > 
    <remap from="~input" to="$(arg INPUT)" />
    <param name="net" value="$(arg NET)" />
  </node>

  <node name="draw_rect_array"
        pkg="jsk_perception" type="draw_rect_array.py">
    <remap from="~input" to="$(arg INPUT)" />
    <remap from="~input/rect_array" to="faster_rcnn/rect_array" />
    <rosparam>
      approximate_sync: True
      slop: 10
    </rosparam>
  </node>

  <node name="faster_rcnn_image_view"
        pkg="image_view" type="image_view">
    <remap from="image" to="draw_rect_array/output" />
    <param name="window_name" value="faster_rcnn_debug" />
  </node>


  <arg name="MANAGER" value="detection_stabilizer_manager" />
  <node name="$(arg MANAGER)"
        pkg="nodelet" type="nodelet"
        output="screen"
        args="manager"/>

  <node name="stabilizer"
        pkg="nodelet" type="nodelet" 
        args="load jsk_perception/DetectionStabilizer $(arg MANAGER)"  >
    <remap from="~input" to="$(arg INPUT)" />
    <remap from="~input/rect_array" to="/faster_rcnn/rect_array" />
    <remap from="~input/classification" to="/faster_rcnn/output" />
    <param name="min_new_detect_intersection_rate" value="0.2" />
  </node>

  <node name="stabilizer_rect_array"
        pkg="jsk_perception" type="draw_rect_array.py">
    <remap from="~input" to="$(arg INPUT)" />
    <remap from="~input/rect_array" to="stabilizer/output/rect_array" />
    <rosparam>
      approximate_sync: True
      slop: 10
    </rosparam>
  </node>

  <node name="stabilizer_image_view"
        pkg="image_view" type="image_view">
    <remap from="image" to="stabilizer_rect_array/output" />
    <param name="window_name" value="stabilizer_output" />
  </node>


  <node name="recognised_tf_publisher"
        pkg="jsk_perception" type="tf_publisher_from_recognition.py">
    <remap from="~input/camera_info" to="/camera/rgb/camera_info" />
    <remap from="~input/rect_array" to="/faster_rcnn/rect_array" />
    <remap from="~input/depth" to="/camera/depth_registered/image_raw" />
    <remap from="~input/recog" to="/faster_rcnn/output" />
  </node>

</launch>
